(()=>{var a=firebase.functions().httpsCallable("loginToXCStats"),b=document.querySelector("#xu-cl-xcstats-loginButton"),c=document.querySelector("#xu-cl-xcstats-loginForm"),d=document.querySelector("#xu-cl-xcstats-email"),e=document.querySelector("#xu-cl-xcstats-password"),f=document.querySelector("#xu-cl-xcstats-submitButton"),g=document.querySelector("#xu-cl-xcstats-loginError"),h=document.querySelector("#xu-cl-strava-loginButton");b.onclick=()=>{[b].forEach(a=>a.disabled=!0),c.classList.remove("d-none")},c.onsubmit=i=>{i.preventDefault(),g.classList.add("d-none"),f.disabled=!0;var j={email:d.value,password:e.value};a(j).then(()=>{g.innerText="",c.classList.add("d-none"),[f,d,e,h].forEach(a=>a.disabled=!1)}).catch(()=>{g.innerText="Incorrect e-mail or password.",g.classList.remove("d-none"),[b,d,e].forEach(a=>a.disabled=!0)}),setTimeout(()=>{""==g.innerText&&(g.innerText="Sorry, this is taking a bit...",g.classList.remove("d-none"))},3e3)}})(),(()=>{var a=firebase.functions().httpsCallable("getStravaLoginURL"),b=document.querySelector("#xu-cl-strava-loginButton"),c=document.querySelector("#xu-stravaLoginError");b.onclick=()=>{b.disabled=!0,firebase.auth().currentUser.getIdToken(!0).then(d=>{a({token:d,developerMode:"localhost"==location.hostname}).then(a=>{location.assign(a.data)}).catch(a=>{c.innerText=JSON.stringify(a),c.classList.remove("d-none"),b.disabled=!1,console.error(a)}),setTimeout(()=>{""==c.innerText&&(c.innerText="Retrieving the URL from the server...",c.classList.remove("d-none"),setTimeout(()=>{"Retrieving the URL from the server..."==c.innerText&&(c.innerHTML="Sorry, this is taking a bit...",c.classList.remove("d-none"))},3e3))},1e3)}).catch(a=>{c.innerHTML="Something went wrong retrieving your Google log-in token. Please try again or <a href='mailto:stassinopoulosari@gmail.com'>send me an email</a>.",c.classList.remove("d-none"),b.disabled=!1,console.error(a)})}})(),(()=>{var a=document.querySelector("#xu-cl-xcstats-loginButton"),b=document.querySelector("#xu-cl-strava-loginButton"),c=document.querySelector("#xu-stravaLoginError"),d=document.querySelector("#xu-signOutButton");d.onclick=()=>firebase.auth().signOut().then(()=>{location.assign("..")}),firebase.auth().onAuthStateChanged(()=>{firebase.auth().currentUser||setTimeout(()=>location.assign(".."),1100);var d=document.querySelector("#xu-cl-loginFlow"),e=document.querySelector("#xu-cl-main");firebase.firestore().doc("users/"+firebase.auth().currentUser.uid).get().then(f=>{firebase.firestore().doc("users/"+firebase.auth().currentUser.uid).set({displayName:firebase.auth().currentUser.displayName},{merge:!0});var g=f.data();if(g&&g["markers.hasLoggedInWithXCStats"]&&!0==g["markers.hasLoggedInWithXCStats"].status&&g["markers.hasLoggedInWithStrava"]&&!0==g["markers.hasLoggedInWithStrava"].status||location.search.includes("stravaAuthSucceeded"))a.disabled=!0,b.disabled=!0,e.classList.remove("d-none"),mainBlock.startMainBlock();else if(g&&g["markers.hasLoggedInWithXCStats"]&&!0==g["markers.hasLoggedInWithXCStats"].status){a.disabled=!0,b.disabled=!1,d.classList.remove("d-none");var h=location.search;c.classList.remove("d-none"),h.includes("stravaAuthError=incorrectScope")?c.innerText="Sorry, we need to be able to see your private activities. We don't save your Strava data anywhere except your own computer.":h.includes("stravaAuthError=firebaseError")?c.innerHTML="Sorry, we couldn't save your Strava token. Please try again or <a href='mailto:stassinopoulosari@gmail.com'>send me an email</a>.":h.includes("stravaAuthError=httpError")?c.innerHTML="Sorry, we couldn't verify your Google log-in token. Please try again or <a href='mailto:stassinopoulosari@gmail.com'>send me an email</a>.":c.classList.add("d-none")}else d.classList.remove("d-none")}).catch(a=>console.error(a))})})();var mainBlock=(()=>{var a=Math.floor,b={};(()=>{var a=localStorage.getItem("xu-cacheContents");a&&(a=JSON.parse(a),!a.ts||21600000<new Date().getTime()-a.ts||(b=a))})();var c=()=>{b.ts=new Date().getTime(),localStorage.setItem("xu-cacheContents",JSON.stringify(b))},d=()=>{localStorage.clear()},e=function(a){var b=document.createElement("div");return b.innerHTML=a.trim(),b.firstChild};return{startMainBlock:()=>{var f=()=>b.activities?Promise.resolve(b.activities):firebase.functions().httpsCallable("downloadStravaActivities")(),g=a=>b.logs?Promise.resolve(b.logs):firebase.functions().httpsCallable("getTwoWeeksOfLogs")(a),h=()=>b.workouts?promise.resolve(b.workouts):firebase.functions().httpsCallable("getWorkouts")(),j=document.querySelector("#xu-cl-stravaDownloadingHeader"),k=document.querySelector("#xu-cl-downloadingInfo"),l=document.querySelector("#xu-cl-stravaActivitiesList"),m=document.querySelector("#xu-cl-activitiesSummary"),n=document.querySelector("#xu-cl-clearCacheButton");n.onclick=()=>{d(),location.reload()},j.classList.remove("d-none"),m.classList.add("d-none");var o=document.querySelector("#template-day").innerHTML,p=document.querySelector("#template-activity").innerHTML;Promise.all([g({date:new Date}).then(a=>(k.innerText+=" XCStats downloading done. Downloading Strava activities...\n",b.logs=a,a)).catch(a=>console.error(a)),f().then(a=>(k.innerText+=" Strava downloading done. Downloading XCStats logs...\n",b.activities=a,a)).catch(a=>console.error(a)),h().then(a=>(k.innerText+=" Workouts downloading done. Downloading XCStats logs & Strava activities...\n",b.workoutsData=a,a)).catch(a=>{console.error(a)})]).then(d=>{var f=d[0],g=d[1],h=d[2];console.log(h),c(),k.innerHTML="",f=f.data;for(var n=[].slice.call(document.querySelectorAll(".xu-logDisplay .xu-logDisplay-contentRow .col:not([class*=xu-hh])")),q=0;7>q;q++){var r=n[q+7],s=n[q],t=[f.lastWeekLog[q].log.reduce((a,b)=>a+b,0),f.thisWeekLog[q].log.reduce((a,b)=>a+b,0)];[r,s].forEach((a,b)=>{a.style.backgroundColor=0==t[b]?"#FFF":1==t[b]?"#888":"#000",a.innerText=0==t[b]?"0":1==t[b]?"1":"2"})}var u=[],v={};[f.lastWeekLog,f.thisWeekLog].forEach(a=>{a.forEach(a=>u.push(a))}),u=u.map(a=>{var b=new Date(a.date),c=(b.getMonth()+1+"").padStart(2,"0")+"/"+(b.getDate()+"").padStart(2,"0")+"/"+(b.getYear()+1900);return a.date=c,a}).forEach(a=>{v[a.date]=a.log.reduce((a,b)=>a+b,0)});var w={},x=g.data;console.log(x),x.forEach(a=>{var b=new Date(a.date),c=(b.getMonth()+1+"").padStart(2,"0")+"/"+(b.getDate()+"").padStart(2,"0")+"/"+(b.getYear()+1900);w[c]?w[c].push(a):w[c]=[a]});var y="";for(var z in w){var A=w[z];y+=o.replace(/%date%/g,z).replace(/%activities%/g,A.map(b=>{var c=e(p.replace(/%title%/g,b.title).replace(/%summary%/g,"distance: "+b.distance.toFixed(1)+" miles; moving time: "+a(b.movingTime/60)+" minutes and "+(b.movingTime%60+"").padStart(2,"0")+" seconds").replace(/%type%/g,b.type).replace(/%url%/g,"https://strava.com/activities/"+b.id).replace(/%disabled%/g,2==v[z]?"disabled":""));return c.querySelector(".selectorBox").setAttribute("data-activitydata",JSON.stringify({date:z,activity:b})),c.outerHTML}).join(""))}l.innerHTML=y,j.classList.add("d-none"),m.classList.remove("d-none");var B=[],C=()=>{console.log(B),0==B.length?[].slice.call(document.querySelectorAll(".addBox")).forEach(a=>{a.disabled=!0,a.classList.add("d-none")}):(document.querySelector(".addBox[data-date='"+B[0].date+"']").classList.remove("d-none"),document.querySelector(".addBox[data-date='"+B[0].date+"']").disabled=!1)};[].slice.call(document.querySelectorAll(".addBox")).forEach(a=>{a.onclick=a=>{a.preventDefault();var d=()=>{var a=B[0].date;[b.logs.data.lastWeekLog,b.logs.data.thisWeekLog].forEach(b=>b.forEach(b=>{b.date==a&&(b.log=1==b.log[0]?[1,1]:[1,0])})),c()};uploadBlock.startUploadBlock(B,v,h,d)}}),[].slice.call(document.querySelectorAll(".selectorBox[data-activitydata]")).forEach(a=>{var b=!1,c=JSON.parse(a.getAttribute("data-activitydata"));a.onclick=d=>{if(d.preventDefault(),!b){var e=!1;0==B.length?(B.push(c),e=!0):B[0].date==c.date&&B[0].activity.type==c.activity.type&&(B.push(c),e=!0),e?(b=!0,C(),a.classList.remove("btn-outline-primary"),a.classList.add("btn-outline-success"),a.innerText="Selected"):(a.classList.remove("btn-outline-primary"),a.classList.add("btn-outline-danger"),a.innerText="Cannot Select",setTimeout(()=>{a.classList.add("btn-outline-primary"),a.classList.remove("btn-outline-danger"),a.innerText="Select"},500))}else{b=!1,a.classList.add("btn-outline-primary"),a.classList.remove("btn-outline-success"),a.innerText="Select";var f=-1;if(B.forEach((a,b)=>{a==c&&(f=b)}),-1==f)return;B.splice(f,1),C()}}})})}}})(),uploadBlock=(()=>({startUploadBlock:(a,b,c,d)=>{var e=Math.floor,f=document.querySelector("#xu-uploadForm"),g=document.querySelector("#xu-uploadInterface"),h=document.querySelector("#xu-cl-main"),i={$cancelButton:"xu-cancelUploadButton",$error:"xu-upload-error",$title:"xu-upload-title",$workout:"xu-upload-workout",$distance:"xu-upload-distance",$time:"xu-upload-time",$description:"xu-upload-description",$effortGroup:"xu-upload-effortGroup",$feelGroup:"xu-upload-feelGroup",$submitButton:"xu-upload-submitButton",$success:"xu-upload-success"},j=()=>{i.$submitButton.disabled=!1,i.$success.classList.add("d-none"),i.$workout.innerHTML="",[i.$effortGroup,i.$feelGroup].forEach(a=>{a.removeAttribute("data-selected"),[].slice.call(a.children).forEach(a=>a.classList.remove("active"))}),h.classList.remove("d-none"),mainBlock.startMainBlock(),g.classList.add("d-none")};for(var k in i)i[k]=document.getElementById(i[k]);i.$cancelButton.onclick=j;var l=firebase.functions().httpsCallable("postToXCStats"),m=a[0].date,n=a;if(n&&0!=n.length){var m=n[0].date,o=n[0].activity.type,p=o;p+=1==n.length?" - "+n[0].activity.title:" - "+m;var q=[["0","No workout"],...c.data].map(a=>"<option value=\""+a[0]+"\">"+a[1]+"</option>").join("");i.$workout.innerHTML=q,i.$workout.onchange=()=>{var a=i.$workout.value;[].slice.call(i.$workout.children).forEach(b=>{if(b.value==a){var c=b.innerText;i.$title.value=c}})},console.log(n);var r=n.map((a,b)=>"Map"+(1<n.length?""+(b+1):"")+": https://strava.com/activities/"+a.activity.id+(a.activity.avgHR&&-1!=a.activity.avgHR?"\n\nAverage Heart Rate: "+a.activity.avgHR+"bpm":"")).join("\n -- \n"),s=n.reduce((a,b)=>a+b.activity.distance,0),t=n.reduce((a,b)=>a+b.activity["movingTime"],0),u=e(t/60),v=e(t%60);i.$title.value=p,i.$distance.innerText=s.toFixed(1)+"mi",i.$time.innerText=u+":"+(v+"").padStart(2,"0"),i.$description.value=r,h.classList.add("d-none"),g.classList.remove("d-none"),[i.$effortGroup,i.$feelGroup].forEach(function(a){var b=[].slice.call(a.children);b.forEach((c,d)=>{c.onclick=()=>{b.forEach(a=>a.classList.remove("active")),c.classList.add("active"),a.setAttribute("data-selected",d)}})});var w=a=>{i.$error.classList.remove("d-none"),i.$error.innerText="Could not submit because "+a,i.$submitButton.disabled=!1};f.onsubmit=a=>{if(a.preventDefault(),i.$error.classList.add("d-none"),i.$submitButton.disabled=!0,""==i.$title.value)return w("the title is blank.");if(!i.$effortGroup.hasAttribute("data-selected"))return w("there is no effort level selected.");if(!i.$feelGroup.hasAttribute("data-selected"))return w("there is no runner feel selected.");var c={recordIndex:b[m],workout:i.$workout.value,title:i.$title.value,date:m,minutes:u,seconds:v,distance:s.toFixed(1),effort:parseInt(i.$effortGroup.getAttribute("data-selected"))+1,runnerFeel:parseInt(i.$feelGroup.getAttribute("data-selected"))+1,description:i.$description.value};l({payload:c}).then(a=>{a.data.includes("success:::")&&(i.$success.classList.remove("d-none"),d(),setTimeout(()=>j(),1e3))}).catch(a=>w(a))}}}}))();(()=>{var a=document.getElementById("xu-settingsButton"),b=document.getElementById("xu-settingsBlock"),c=document.getElementById("xu-s-closeSettingsButton"),d=document.getElementById("xu-s-deleteDataButton"),e=document.getElementById("xu-s-deleteAccountButton"),f=document.getElementById("xu-s-deletionError");$otherBlocks=["xu-uploadInterface","xu-cl-main","xu-cl-loginFlow","xu-settingsButton","xu-s-spacer"].map(a=>document.getElementById(a)),a.onclick=()=>{$otherBlocks.forEach(a=>a.classList.add("d-none")),b.classList.remove("d-none")},c.onclick=()=>location.reload();var g=(a=!1)=>new Promise(function(b,c){var d=firebase.auth().currentUser.uid;d&&(confirm("Are you sure you would like to delete your "+(a?"account":"data")+"?")?firebase.firestore().doc("users/"+d).delete().then(b).catch(a=>c({status:!1,error:a})):c({status:!1,error:{message:"User did not confirm."}}))}),h=()=>new Promise(function(a,b){g(!0).then(()=>{var c=new firebase.auth.GoogleAuthProvider;firebase.auth().signInWithPopup(c).then(()=>{firebase.auth().currentUser.delete().then(()=>{a()}).catch(a=>{b({status:!1,error:a})})}).catch(b)}).catch(b)});d.onclick=()=>{[d,e].forEach(a=>a.disabled=!0),g().then(()=>{f.innerText="Deletion succeeded. Reloading...",f.classList.remove("d-none"),setTimeout(()=>location.assign(location.href.split("?")[0]),1e3)}).catch(a=>{f.innerText=a,f.classList.remove("d-none"),[d,e].forEach(a=>a.disabled=!1)})},e.onclick=()=>{[d,e].forEach(a=>a.disabled=!0),h().then(()=>{f.innerText="Deletion succeeded. Goodbye.",f.classList.remove("d-none"),setTimeout(()=>location.assign(".."),1e3)}).catch(a=>{f.innerText=a.error.message,f.classList.remove("d-none"),[d,e].forEach(a=>a.disabled=!1)})}})();