(()=>{var a=firebase.functions().httpsCallable("loginToXCStats"),b=document.querySelector("#xu-cl-xcstats-loginButton"),c=document.querySelector("#xu-cl-xcstats-loginForm"),d=document.querySelector("#xu-cl-xcstats-email"),e=document.querySelector("#xu-cl-xcstats-password"),f=document.querySelector("#xu-cl-xcstats-submitButton"),g=document.querySelector("#xu-cl-xcstats-loginError"),h=document.querySelector("#xu-cl-strava-loginButton");b.onclick=()=>{[b].forEach(a=>a.disabled=!0),c.classList.remove("d-none")},c.onsubmit=i=>{i.preventDefault(),g.classList.add("d-none"),f.disabled=!0;var j={email:d.value,password:e.value};a(j).then(()=>{g.innerText="",c.classList.add("d-none"),[f,d,e,h].forEach(a=>a.disabled=!1)}).catch(()=>{g.innerText="Incorrect e-mail or password.",g.classList.remove("d-none"),[b,d,e].forEach(a=>a.disabled=!0)}),setTimeout(()=>{""==g.innerText&&(g.innerText="Sorry, this is taking a bit...",g.classList.remove("d-none"))},3e3)}})(),(()=>{var a=firebase.functions().httpsCallable("getStravaLoginURL"),b=document.querySelector("#xu-cl-strava-loginButton"),c=document.querySelector("#xu-stravaLoginError");b.onclick=()=>{b.disabled=!0,firebase.auth().currentUser.getIdToken(!0).then(d=>{a({token:d,developerMode:"localhost"==location.hostname}).then(a=>{location.assign(a.data)}).catch(a=>{c.innerText=JSON.stringify(a),c.classList.remove("d-none"),b.disabled=!1,console.error(a)}),setTimeout(()=>{""==c.innerText&&(c.innerText="Retrieving the URL from the server...",c.classList.remove("d-none"),setTimeout(()=>{"Retrieving the URL from the server..."==c.innerText&&(c.innerHTML="Sorry, this is taking a bit...",c.classList.remove("d-none"))},3e3))},1e3)}).catch(a=>{c.innerHTML="Something went wrong retrieving your Google log-in token. Please try again or <a href='mailto:stassinopoulosari@gmail.com'>send me an email</a>.",c.classList.remove("d-none"),b.disabled=!1,console.error(a)})}})(),(()=>{var a=document.querySelector("#xu-cl-xcstats-loginButton"),b=document.querySelector("#xu-cl-strava-loginButton"),c=document.querySelector("#xu-stravaLoginError"),d=document.querySelector("#xu-signOutButton");d.onclick=()=>firebase.auth().signOut().then(()=>{location.assign("..")}),firebase.auth().onAuthStateChanged(()=>{firebase.auth().currentUser||setTimeout(()=>location.assign(".."),1100);var d=document.querySelector("#xu-cl-loginFlow"),e=document.querySelector("#xu-cl-main");firebase.firestore().doc("users/"+firebase.auth().currentUser.uid).get().then(f=>{firebase.firestore().doc("users/"+firebase.auth().currentUser.uid).set({displayName:firebase.auth().currentUser.displayName},{merge:!0});var g=f.data();if(g&&g["markers.hasLoggedInWithXCStats"]&&!0==g["markers.hasLoggedInWithXCStats"].status&&g["markers.hasLoggedInWithStrava"]&&!0==g["markers.hasLoggedInWithStrava"].status||location.search.includes("stravaAuthSucceeded"))a.disabled=!0,b.disabled=!0,e.classList.remove("d-none"),mainBlock.startMainBlock();else if(g&&g["markers.hasLoggedInWithXCStats"]&&!0==g["markers.hasLoggedInWithXCStats"].status){a.disabled=!0,b.disabled=!1,d.classList.remove("d-none");var h=location.search;c.classList.remove("d-none"),h.includes("stravaAuthError=incorrectScope")?c.innerText="Sorry, we need to be able to see your private activities. We don't save your Strava data anywhere except your own computer.":h.includes("stravaAuthError=firebaseError")?c.innerHTML="Sorry, we couldn't save your Strava token. Please try again or <a href='mailto:stassinopoulosari@gmail.com'>send me an email</a>.":h.includes("stravaAuthError=httpError")?c.innerHTML="Sorry, we couldn't verify your Google log-in token. Please try again or <a href='mailto:stassinopoulosari@gmail.com'>send me an email</a>.":c.classList.add("d-none")}else d.classList.remove("d-none")}).catch(a=>console.error(a))})})();var mainBlock=(()=>{var a=Math.floor,b={};(()=>{var a=localStorage.getItem("xu-cacheContents");a&&(a=JSON.parse(a),!a.ts||21600000<new Date().getTime()-a.ts||(b=a))})();var c=()=>{b.ts=new Date().getTime(),localStorage.setItem("xu-cacheContents",JSON.stringify(b))},d=()=>{localStorage.clear()},e=function(a){var b=document.createElement("div");return b.innerHTML=a.trim(),b.firstChild};return{startMainBlock:()=>{var f=()=>b.activities?Promise.resolve(b.activities):firebase.functions().httpsCallable("downloadStravaActivities")(),g=a=>b.logs?Promise.resolve(b.logs):firebase.functions().httpsCallable("getTwoWeeksOfLogs")(a),h=document.querySelector("#xu-cl-stravaDownloadingHeader"),j=document.querySelector("#xu-cl-downloadingInfo"),k=document.querySelector("#xu-cl-stravaActivitiesList"),l=document.querySelector("#xu-cl-activitiesSummary"),m=document.querySelector("#xu-cl-clearCacheButton");m.onclick=()=>{d(),location.reload()},h.classList.remove("d-none"),l.classList.add("d-none");var n=document.querySelector("#template-day").innerHTML,o=document.querySelector("#template-activity").innerHTML;Promise.all([g({date:new Date}).then(a=>(j.innerText+=" XCStats downloading done. Downloading Strava activities...",b.logs=a,a)).catch(a=>console.error(a)),f().then(a=>(j.innerText+=" Strava downloading done. Downloading XCStats logs...",b.activities=a,a)).catch(a=>console.error(a))]).then(d=>{var f=d[0],g=d[1];c(),j.innerText+="",f=f.data;for(var m=[].slice.call(document.querySelectorAll(".xu-logDisplay .xu-logDisplay-contentRow .col:not([class*=xu-hh])")),p=0;7>p;p++){var q=m[p+7],r=m[p],s=[f.lastWeekLog[p].log.reduce((a,b)=>a+b,0),f.thisWeekLog[p].log.reduce((a,b)=>a+b,0)];[q,r].forEach((a,b)=>{a.style.backgroundColor=0==s[b]?"#FFF":1==s[b]?"#888":"#000",a.innerText=0==s[b]?"0":1==s[b]?"1":"2"})}var t=[],u={};[f.lastWeekLog,f.thisWeekLog].forEach(a=>{a.forEach(a=>t.push(a))}),t=t.map(a=>{var b=new Date(a.date),c=(b.getMonth()+1+"").padStart(2,"0")+"/"+(b.getDate()+"").padStart(2,"0")+"/"+(b.getYear()+1900);return a.date=c,a}).forEach(a=>{u[a.date]=a.log.reduce((a,b)=>a+b,0)});var v={},w=g.data;console.log(w),w.forEach(a=>{var b=new Date(a.date),c=(b.getMonth()+1+"").padStart(2,"0")+"/"+(b.getDate()+"").padStart(2,"0")+"/"+(b.getYear()+1900);v[c]?v[c].push(a):v[c]=[a]});var x="";for(var y in v){var z=v[y];x+=n.replace(/%date%/g,y).replace(/%activities%/g,z.map(b=>{var c=e(o.replace(/%title%/g,b.title).replace(/%summary%/g,"distance: "+b.distance.toFixed(1)+" miles; moving time: "+a(b.movingTime/60)+" minutes and "+(b.movingTime%60+"").padStart(2,"0")+" seconds").replace(/%type%/g,b.type).replace(/%url%/g,"https://strava.com/activities/"+b.id).replace(/%disabled%/g,2==u[y]?"disabled":""));return c.querySelector(".selectorBox").setAttribute("data-activitydata",JSON.stringify({date:y,activity:b})),c.outerHTML}).join(""))}k.innerHTML=x,h.classList.add("d-none"),l.classList.remove("d-none");var A=[],B=()=>{0==A.length?[].slice.call(document.querySelectorAll(".addBox")).forEach(a=>{a.disabled=!0,a.classList.add("d-none")}):(document.querySelector(".addBox[data-date='"+A[0].date+"']").classList.remove("invisible"),document.querySelector(".addBox[data-date='"+A[0].date+"']").disabled=!1)};[].slice.call(document.querySelectorAll(".addBox")).forEach(a=>{a.onclick=a=>{a.preventDefault();var d=()=>{var a=A[0].date;[b.logs.data.lastWeekLog,b.logs.data.thisWeekLog].forEach(b=>b.forEach(b=>{b.date==a&&(b.log=1==b.log[0]?[1,1]:[1,0])})),c()};uploadBlock.startUploadBlock(A,u,d)}}),[].slice.call(document.querySelectorAll(".selectorBox[data-activitydata]")).forEach(a=>{var b=!1,c=JSON.parse(a.getAttribute("data-activitydata"));a.onclick=d=>{if(d.preventDefault(),!b){var e=!1;0==A.length?(A.push(c),e=!0):A[0].date==c.date&&A[0].activity.type==c.activity.type&&(A.push(c),e=!0),e?(b=!0,B(),a.classList.remove("btn-outline-primary"),a.classList.add("btn-outline-success"),a.innerText="Selected"):(a.classList.remove("btn-outline-primary"),a.classList.add("btn-outline-danger"),a.innerText="Cannot Select",setTimeout(()=>{a.classList.add("btn-outline-primary"),a.classList.remove("btn-outline-danger"),a.innerText="Select"},500))}else{b=!1,a.classList.add("btn-outline-primary"),a.classList.remove("btn-outline-success"),a.innerText="Select";var f=-1;if(A.forEach((a,b)=>{a==c&&(f=b)}),-1==f)return;A.splice(f,1),B()}}})})}}})(),uploadBlock=(()=>({startUploadBlock:(a,b,c)=>{var d=Math.floor,e=document.querySelector("#xu-uploadForm"),f=document.querySelector("#xu-uploadInterface"),g=document.querySelector("#xu-cl-main"),h={$cancelButton:"xu-cancelUploadButton",$error:"xu-upload-error",$title:"xu-upload-title",$distance:"xu-upload-distance",$time:"xu-upload-time",$description:"xu-upload-description",$effortGroup:"xu-upload-effortGroup",$feelGroup:"xu-upload-feelGroup",$submitButton:"xu-upload-submitButton",$success:"xu-upload-success"},i=()=>{h.$submitButton.disabled=!1,h.$success.classList.add("d-none"),[h.$effortGroup,h.$feelGroup].forEach(a=>{a.removeAttribute("data-selected"),[].slice.call(a.children).forEach(a=>a.classList.remove("active"))}),g.classList.remove("d-none"),mainBlock.startMainBlock(),f.classList.add("d-none")};for(var j in h)h[j]=document.getElementById(h[j]);h.$cancelButton.onclick=i;var k=firebase.functions().httpsCallable("postToXCStats"),l=a[0].date,m=a;if(m&&0!=m.length){var l=m[0].date,n=m[0].activity.type,o=n;o+=1==m.length?" - "+m[0].activity.title:" - "+l,console.log(m);var p=m.map((a,b)=>"Map"+(1<m.length?""+(b+1):"")+": https://strava.com/activities/"+a.activity.id+(a.activity.avgHR&&-1!=a.activity.avgHR?"\n\nAverage Heart Rate: "+a.activity.avgHR+"bpm":"")).join("\n -- \n"),q=m.reduce((a,b)=>a+b.activity.distance,0),r=m.reduce((a,b)=>a+b.activity["movingTime"],0),s=d(r/60),t=d(r%60);h.$title.value=o,h.$distance.innerText=q.toFixed(1)+"mi",h.$time.innerText=s+":"+(t+"").padStart(2,"0"),h.$description.value=p,g.classList.add("d-none"),f.classList.remove("d-none"),[h.$effortGroup,h.$feelGroup].forEach(function(a){var b=[].slice.call(a.children);b.forEach((c,d)=>{c.onclick=()=>{b.forEach(a=>a.classList.remove("active")),c.classList.add("active"),a.setAttribute("data-selected",d)}})});var u=a=>{h.$error.classList.remove("d-none"),h.$error.innerText="Could not submit because "+a,h.$submitButton.disabled=!1};e.onsubmit=a=>{if(a.preventDefault(),h.$error.classList.add("d-none"),h.$submitButton.disabled=!0,""==h.$title.value)return u("the title is blank.");if(!h.$effortGroup.hasAttribute("data-selected"))return u("there is no effort level selected.");if(!h.$feelGroup.hasAttribute("data-selected"))return u("there is no runner feel selected.");var d={recordIndex:b[l],title:h.$title.value,date:l,minutes:s,seconds:t,distance:q.toFixed(1),effort:parseInt(h.$effortGroup.getAttribute("data-selected"))+1,runnerFeel:parseInt(h.$feelGroup.getAttribute("data-selected"))+1,description:h.$description.value};k({payload:d}).then(a=>{a.data.includes("success:::")&&(h.$success.classList.remove("d-none"),c(),setTimeout(()=>i(),1e3))}).catch(a=>u(a))}}}}))();(()=>{var a=document.getElementById("xu-settingsButton"),b=document.getElementById("xu-settingsBlock"),c=document.getElementById("xu-s-closeSettingsButton"),d=document.getElementById("xu-s-deleteDataButton"),e=document.getElementById("xu-s-deleteAccountButton"),f=document.getElementById("xu-s-deletionError");$otherBlocks=["xu-uploadInterface","xu-cl-main","xu-cl-loginFlow","xu-settingsButton","xu-s-spacer"].map(a=>document.getElementById(a)),a.onclick=()=>{$otherBlocks.forEach(a=>a.classList.add("d-none")),b.classList.remove("d-none")},c.onclick=()=>location.reload();var g=(a=!1)=>new Promise(function(b,c){var d=firebase.auth().currentUser.uid;d&&(confirm("Are you sure you would like to delete your "+(a?"account":"data")+"?")?firebase.firestore().doc("users/"+d).delete().then(b).catch(a=>c({status:!1,error:a})):c({status:!1,error:{message:"User did not confirm."}}))}),h=()=>new Promise(function(a,b){g(!0).then(()=>{var c=new firebase.auth.GoogleAuthProvider;firebase.auth().signInWithPopup(c).then(()=>{firebase.auth().currentUser.delete().then(()=>{a()}).catch(a=>{b({status:!1,error:a})})}).catch(b)}).catch(b)});d.onclick=()=>{[d,e].forEach(a=>a.disabled=!0),g().then(()=>{f.innerText="Deletion succeeded. Reloading...",f.classList.remove("d-none"),setTimeout(()=>location.assign(location.href.split("?")[0]),1e3)}).catch(a=>{f.innerText=a,f.classList.remove("d-none"),[d,e].forEach(a=>a.disabled=!1)})},e.onclick=()=>{[d,e].forEach(a=>a.disabled=!0),h().then(()=>{f.innerText="Deletion succeeded. Goodbye.",f.classList.remove("d-none"),setTimeout(()=>location.assign(".."),1e3)}).catch(a=>{f.innerText=a.error.message,f.classList.remove("d-none"),[d,e].forEach(a=>a.disabled=!1)})}})();