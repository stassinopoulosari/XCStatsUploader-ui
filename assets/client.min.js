(()=>{var a=firebase.functions().httpsCallable("loginToXCStats"),b=document.querySelector("#xu-cl-xcstats-loginButton"),c=document.querySelector("#xu-cl-xcstats-loginForm"),d=document.querySelector("#xu-cl-xcstats-email"),e=document.querySelector("#xu-cl-xcstats-password"),f=document.querySelector("#xu-cl-xcstats-submitButton"),g=document.querySelector("#xu-cl-xcstats-loginError"),h=document.querySelector("#xu-cl-strava-loginButton");b.onclick=()=>{[b,d,e].forEach(a=>a.disabled=!0),c.classList.remove("d-none")},c.onsubmit=i=>{i.preventDefault(),g.classList.add("d-none"),f.disabled=!0;var j={email:d.value,password:e.value};a(j).then(()=>{g.innerText="",c.classList.add("d-none"),[f,d,e,h].forEach(a=>a.disabled=!1)}).catch(()=>{g.innerText="Incorrect e-mail or password.",g.classList.remove("d-none"),[b,d,e].forEach(a=>a.disabled=!0)}),setTimeout(()=>{""==g.innerText&&(g.innerText="Sorry, this is taking a bit...",g.classList.remove("d-none"))},3e3)}})(),(()=>{var a=firebase.functions().httpsCallable("getStravaLoginURL"),b=document.querySelector("#xu-cl-strava-loginButton"),c=document.querySelector("#xu-stravaLoginError");b.onclick=()=>{b.disabled=!0,firebase.auth().currentUser.getIdToken(!0).then(d=>{a({token:d,developerMode:"localhost"==location.hostname}).then(a=>{location.assign(a.data)}).catch(a=>{c.innerText=JSON.stringify(a),c.classList.remove("d-none"),b.disabled=!1,console.error(a)}),setTimeout(()=>{""==c.innerText&&(c.innerText="Retrieving the URL from the server...",c.classList.remove("d-none"),setTimeout(()=>{"Retrieving the URL from the server..."==c.innerText&&(c.innerHTML="Sorry, this is taking a bit...",c.classList.remove("d-none"))},3e3))},1e3)}).catch(a=>{c.innerHTML="Something went wrong retrieving your Google log-in token. Please try again or <a href='mailto:stassinopoulosari@gmail.com'>send me an email</a>.",c.classList.remove("d-none"),b.disabled=!1,console.error(a)})}})(),(()=>{var a=document.querySelector("#xu-cl-xcstats-loginButton"),b=document.querySelector("#xu-cl-strava-loginButton"),c=document.querySelector("#xu-stravaLoginError"),d=document.querySelector("#xu-signOutButton");d.onclick=()=>firebase.auth().signOut().then(()=>{location.assign("..")}),firebase.auth().onAuthStateChanged(()=>{firebase.auth().currentUser||location.assign("..");var d=document.querySelector("#xu-cl-loginFlow"),e=document.querySelector("#xu-cl-main");firebase.firestore().doc("users/"+firebase.auth().currentUser.uid).get().then(f=>{var g=f.data();if(console.log(g),g&&g["markers.hasLoggedInWithXCStats"]&&!0==g["markers.hasLoggedInWithXCStats"].status&&g["markers.hasLoggedInWithStrava"]&&!0==g["markers.hasLoggedInWithStrava"].status||location.search.includes("stravaAuthSucceeded"))a.disabled=!0,b.disabled=!0,e.classList.remove("d-none"),mainBlock.startMainBlock();else if(g&&g["markers.hasLoggedInWithXCStats"]&&!0==g["markers.hasLoggedInWithXCStats"].status){a.disabled=!0,b.disabled=!1,d.classList.remove("d-none");var h=location.search;c.classList.remove("d-none"),h.includes("stravaAuthError=incorrectScope")?c.innerText="Sorry, we need to be able to see your private activities. We don't save your Strava data anywhere except your own computer.":h.includes("stravaAuthError=firebaseError")?c.innerHTML="Sorry, we couldn't save your Strava token. Please try again or <a href='mailto:stassinopoulosari@gmail.com'>send me an email</a>.":h.includes("stravaAuthError=httpError")?c.innerHTML="Sorry, we couldn't verify your Google log-in token. Please try again or <a href='mailto:stassinopoulosari@gmail.com'>send me an email</a>.":c.classList.add("d-none")}else d.classList.remove("d-none")}).catch(a=>console.error(a))})})();var mainBlock=(()=>{var a=Math.floor,b=function(a){var b=document.createElement("div");return b.innerHTML=a.trim(),b.firstChild};return{startMainBlock:()=>{var c=firebase.functions().httpsCallable("downloadStravaActivities"),d=firebase.functions().httpsCallable("getTwoWeeksOfLogs"),e=document.querySelector("#xu-cl-stravaDownloadingHeader"),f=document.querySelector("#xu-cl-stravaActivitiesList"),g=document.querySelector("#xu-cl-activitiesSummary");e.classList.remove("d-none"),g.classList.add("d-none");var h=document.querySelector("#template-day").innerHTML,i=document.querySelector("#template-activity").innerHTML;d({date:new Date}).then(d=>{d=d.data;for(var j=[].slice.call(document.querySelectorAll(".xu-logDisplay .xu-logDisplay-contentRow .col:not([class*=xu-hh])")),k=0;7>k;k++){var l=j[k+7],m=j[k],n=[d.lastWeekLog[k].log.reduce((a,b)=>a+b,0),d.thisWeekLog[k].log.reduce((a,b)=>a+b,0)];[l,m].forEach((a,b)=>{a.style.backgroundColor=0==n[b]?"#FFF":1==n[b]?"#888":"#000",a.innerText=0==n[b]?"0":1==n[b]?"1":"2"})}var o=[],p={};[d.lastWeekLog,d.thisWeekLog].forEach(a=>{a.forEach(a=>o.push(a))}),o=o.map(a=>{var b=new Date(a.date),c=(b.getMonth()+1+"").padStart(2,"0")+"/"+(b.getDate()+"").padStart(2,"0")+"/"+(b.getYear()+1900);return a.date=c,a}).forEach(a=>{p[a.date]=a.log.reduce((a,b)=>a+b,0)}),c().then(c=>{var d={},j=c.data;console.log(j),j.forEach(a=>{var b=new Date(a.date),c=(b.getMonth()+1+"").padStart(2,"0")+"/"+(b.getDate()+"").padStart(2,"0")+"/"+(b.getYear()+1900);d[c]?d[c].push(a):d[c]=[a]});var k="";for(var l in d){var m=d[l];k+=h.replace(/%date%/g,l).replace(/%activities%/g,m.map(c=>{var d=b(i.replace(/%title%/g,c.title).replace(/%summary%/g,"distance: "+c.distance.toFixed(1)+" miles; moving time: "+a(c.movingTime/60)+" minutes and "+(c.movingTime%60+"").padStart(2,"0")+" seconds").replace(/%type%/g,c.type).replace(/%url%/g,"https://strava.com/activities/"+c.id).replace(/%disabled%/g,2==p[l]?"disabled":""));return d.querySelector(".selectorBox").setAttribute("data-activitydata",JSON.stringify({date:l,activity:c})),d.outerHTML}).join(""))}f.innerHTML=k,e.classList.add("d-none"),g.classList.remove("d-none");var n=[],o=()=>{0==n.length?[].slice.call(document.querySelectorAll(".addBox")).forEach(a=>{a.disabled=!0,a.classList.add("invisible")}):(document.querySelector(".addBox[data-date='"+n[0].date+"']").classList.remove("invisible"),document.querySelector(".addBox[data-date='"+n[0].date+"']").disabled=!1)};[].slice.call(document.querySelectorAll(".addBox")).forEach(a=>{a.onclick=a=>{a.preventDefault(),uploadBlock.startUploadBlock(n,p)}}),[].slice.call(document.querySelectorAll(".selectorBox[data-activitydata]")).forEach(a=>{var b=!1,c=JSON.parse(a.getAttribute("data-activitydata"));a.onclick=d=>{if(d.preventDefault(),!b){var e=!1;0==n.length?(n.push(c),e=!0):n[0].date==c.date&&n[0].activity.type==c.activity.type&&(n.push(c),e=!0),e?(b=!0,o(),a.classList.remove("btn-outline-primary"),a.classList.add("btn-outline-success"),a.innerText="Selected"):(a.classList.remove("btn-outline-primary"),a.classList.add("btn-outline-danger"),a.innerText="Cannot Select",setTimeout(()=>{a.classList.add("btn-outline-primary"),a.classList.remove("btn-outline-danger"),a.innerText="Select"},500))}else{b=!1,a.classList.add("btn-outline-primary"),a.classList.remove("btn-outline-success"),a.innerText="Select";var f=-1;if(n.forEach((a,b)=>{a==c&&(f=b)}),-1==f)return;n.splice(f,1),o()}}})}).catch(a=>console.error(a))}).catch(a=>console.error(a))}}})(),uploadBlock=(()=>({startUploadBlock:(a,b)=>{var c=Math.floor,d=document.querySelector("#xu-uploadForm"),e=document.querySelector("#xu-uploadInterface"),f=document.querySelector("#xu-cl-main"),g={$cancelButton:"xu-cancelUploadButton",$error:"xu-upload-error",$title:"xu-upload-title",$distance:"xu-upload-distance",$time:"xu-upload-time",$description:"xu-upload-description",$effortGroup:"xu-upload-effortGroup",$feelGroup:"xu-upload-feelGroup",$submitButton:"xu-upload-submitButton",$success:"xu-upload-success"},h=()=>{g.$submitButton.disabled=!1,g.$success.classList.add("d-none"),[g.$effortGroup,g.$feelGroup].forEach(a=>{a.removeAttribute("data-selected"),[].slice.call(a.children).forEach(a=>a.classList.remove("active"))}),f.classList.remove("d-none"),mainBlock.startMainBlock(),e.classList.add("d-none")};for(var i in g)g[i]=document.getElementById(g[i]);g.$cancelButton.onclick=h;var j=firebase.functions().httpsCallable("postToXCStats"),k=a[0].date,l=a;if(l&&0!=l.length){var k=l[0].date,m=l[0].activity.type,n=m;n+=1==l.length?" - "+l[0].activity.title:" - "+k,console.log(l);var o=l.map((a,b)=>"Map"+(1<l.length?""+(b+1):"")+": https://strava.com/activities/"+a.activity.id+(a.activity.avgHR&&-1!=a.activity.avgHR?"\n\nAverage Heart Rate: "+a.activity.avgHR+"bpm":"")).join("\n -- \n"),p=l.reduce((a,b)=>a+b.activity.distance,0),q=l.reduce((a,b)=>a+b.activity["movingTime"],0),r=c(q/60),s=c(q%60);g.$title.value=n,g.$distance.innerText=p.toFixed(1)+"mi",g.$time.innerText=r+":"+(s+"").padStart(2,"0"),g.$description.value=o,f.classList.add("d-none"),e.classList.remove("d-none"),[g.$effortGroup,g.$feelGroup].forEach(function(a){var b=[].slice.call(a.children);b.forEach((c,d)=>{c.onclick=()=>{b.forEach(a=>a.classList.remove("active")),c.classList.add("active"),a.setAttribute("data-selected",d)}})});var t=a=>{g.$error.classList.remove("d-none"),g.$error.innerText="Could not submit because "+a,g.$submitButton.disabled=!1};d.onsubmit=a=>{if(a.preventDefault(),g.$error.classList.add("d-none"),g.$submitButton.disabled=!0,""==g.$title.value)return t("the title is blank.");if(!g.$effortGroup.hasAttribute("data-selected"))return t("there is no effort level selected.");if(!g.$feelGroup.hasAttribute("data-selected"))return t("there is no runner feel selected.");var c={recordIndex:b[k],title:g.$title.value,date:k,minutes:r,seconds:s,distance:p.toFixed(1),effort:parseInt(g.$effortGroup.getAttribute("data-selected"))+1,runnerFeel:parseInt(g.$feelGroup.getAttribute("data-selected"))+1,description:g.$description.value};j({payload:c}).then(a=>{a.data.includes("success:::")&&(g.$success.classList.remove("d-none"),setTimeout(()=>h(),1e3))}).catch(a=>t(a))}}}}))();(()=>{var a=document.getElementById("xu-settingsButton"),b=document.getElementById("xu-settingsBlock"),c=document.getElementById("xu-s-closeSettingsButton"),d=document.getElementById("xu-s-deleteDataButton"),e=document.getElementById("xu-s-deleteAccountButton"),f=document.getElementById("xu-s-deletionError");$otherBlocks=["xu-uploadInterface","xu-cl-main","xu-cl-loginFlow","xu-settingsButton","xu-s-spacer"].map(a=>document.getElementById(a)),a.onclick=()=>{$otherBlocks.forEach(a=>a.classList.add("d-none")),b.classList.remove("d-none")},c.onclick=()=>location.reload();var g=(a=!1)=>new Promise(function(b,c){var d=firebase.auth().currentUser.uid;d&&(confirm("Are you sure you would like to delete your "+(a?"account":"data")+"?")?firebase.firestore().doc("users/"+d).set({}).then(b).catch(a=>c({status:!1,error:a})):c({status:!1,error:{message:"User did not confirm."}}))}),h=()=>new Promise(function(a,b){g(!0).then(()=>{var c=new firebase.auth.GoogleAuthProvider;firebase.auth().signInWithPopup(c).then(()=>{firebase.auth().currentUser.delete().then(()=>{a()}).catch(a=>{b({status:!1,error:a})})}).catch(b)}).catch(b)});d.onclick=()=>{[d,e].forEach(a=>a.disabled=!0),g().then(()=>{f.innerText="Deletion succeeded. Reloading...",f.classList.remove("d-none"),setTimeout(()=>location.assign(location.href.split("?")[0]),1e3)}).catch(a=>{f.innerText=a,f.classList.remove("d-none"),[d,e].forEach(a=>a.disabled=!1)})},e.onclick=()=>{[d,e].forEach(a=>a.disabled=!0),h().then(()=>{f.innerText="Deletion succeeded. Goodbye.",f.classList.remove("d-none"),setTimeout(()=>location.assign(".."),4e3)}).catch(a=>{f.innerText=a.error.message,f.classList.remove("d-none"),[d,e].forEach(a=>a.disabled=!1)})}})();